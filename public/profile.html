<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAMCA</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/profile.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
  <section class="desktop-nav">
        <div class="logos">
        <a href="index.html"><img src="images/TAMCA Logo.png" alt="TAMCA Logo"></a>
        <a href="index.html"><img src="images/selimiye-mosque-logo.png" alt="TAMCA Logo"></a>
        </div>
        <nav class="navbar-desktop">
        <div class="nav-links" id="navLinks">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="donate.html">Donate</a></li>
                <li><a href="profile.html">Profile</a></li>
                <li><a href="education.html">Education</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
        </div>
    </nav>
    <div class="btnLogout" id="btnLogout">
      <ion-icon name="log-out-outline" class="logout-outline"></ion-icon><br>
      <span>Log Out</span>
  </div>
</section>

<section class="mobile-nav">
    <nav class="nav-mobile">
        <a href="index.html" class="nav-links-mobile">
            <ion-icon name="home"></ion-icon>
                <span class="nav-text">Home</span>
        </a>
        <a href="donate.html" class="nav-links-mobile ">
            <ion-icon name="logo-paypal"></ion-icon>
                <span class="nav-text">Donate</span>
        </a>
        <a href="profile.html" class="nav-links-mobile nav-icon link-active-mobile">
            <ion-icon name="person-circle"></ion-icon>
                <span class="nav-text">Profile</span>
        </a>
        <a href="education.html" class="nav-links-mobile">
            <ion-icon name="school"></ion-icon>
                <span class="nav-text">Education</span>
        </a>
        <a href="contact.html" class="nav-links-mobile">
            <ion-icon name="chatbubble"></ion-icon>
                <span class="nav-text">Contact</span>
        </a>
    </nav>
</section>

<section class="content">
  <div class="banner">
      <h1>Dashboard</h1>
  </div>

  <div class="container">
    <div class="inner">
      <div class="card" id="welcome-card">
        <div class="profile-container">
          <h2>Welcome,&nbsp;<span id="first-name"></span>&nbsp;<span id="last-name"></span></h2>
          <div class="profile-info">
            <div class="row">
              <label for="profile-email">Email:</label>
              <span id="profile-email" contenteditable="false"></span>
            </div>
            <div class="row">
              <label for="phone">Phone:</label>
              <span id="phone" contenteditable="false"></span>
            </div>
          </div>
        </div>
      </div>      
      
      <div class="card" id="membership-card"><h3>Membership</h3>
        <div class="membership-content">
        <p>Status: <span id="membershipStatus"></span></p>
        <p>Auto Renewal: <span id="autoRenewal"></span></p>
        <p>Renewal Date: <span id="renewalDate"></span></p>
        <p><b>Manage Membership</b><span id="manageMembership" class="manageMembership"></span></p>
      </div>
      </div>
      <div class="card" id="donation-card">
        <h3>Donations</h3>
        <table id="donation-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Amount</th>
              <th>Cause</th>
            </tr>
          </thead>
          <tbody id="donation-table-body">
            <!-- Donation data will be populated here dynamically -->
          </tbody>
        </table>
        <b>View full donation history</b>
      </div>
      
      <div class="card" id="household-card">
        <h3><ion-icon name="home-outline"></ion-icon>&nbsp;My Household</h3>
        <div class="household-content">
          <div class="my-household-section">
            <p><ion-icon name="location-outline"></ion-icon>&nbsp;<span id="householdAddress"></span></p>
          </div>
          <div class="members-section">
            <h4><ion-icon name="people-outline"></ion-icon>&nbsp;Members</h4>
            <span id="householdMembers"></span>
          </div>
        </div>
      </div>      
      <div class="card" id="more-card"><h3>Additional Resources</h3>
        <div class="more-content">
          <p>Education <span id="educationInfo"></span></p>
          <p>Memorial Services <span id="memorialInfo"></span></p>
          <p>Privacy Policy <span id="renewalDate"></span></p>
        </div>
      </div>
    </div>
  </div>
</section>
    
  <!-- Site footer -->
  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-row">
        <div class="footer-about">
          <h6>About</h6>
          <p class="text-justify">Our goal is to provide those in our community with the highest quality of services, education, and assistance. We aim to provide education about Turkish culture and the Islamic religion for anyone who is or may be interested in learning and offer classes year-round. We also provide services to our members and allow everyone to participate in community service opportunities. We provided assistance for those in need by utilizing our donation platform(s) as well as the selfless kind acts of our members. We have been providing education and services for over 30 years and continue to for families and children in our community. We also host fundraisers and events with special hosts to help build stronger connections for everyone in our community.</p>
        </div>

        <div class="footer-contact">
          <h6>Contact</h6>
          <ul class="footer-links">
            <li><a href="https://maps.app.goo.gl/X13j3HETgLPk1YBJA"><ion-icon name="location-sharp"></ion-icon> 541 Levittown Parkway, Levittown, PA 19054</a></li>
            <li><a href="tel:12673640615"><ion-icon name="call-sharp"></ion-icon> +1 (267) 364-0615</a></li>
            <li><a href="http://scanfcode.com/category/back-end-development/"><ion-icon name="mail-sharp"></ion-icon> tamca@tamca.org</a></li>
          </ul>
        </div>

        <div class="footer-quicklinks">
          <h6>Quick Links</h6>
          <ul class="footer-links">
            <li><a href="https://tamca.org/contact.html">Contact Us</a></li>
            <li><a href="https://tamca.org/memorial.html">Memorial Services</a></li>
            <li><a href="https://tamca.org/privacy.html">Privacy Policy</a></li>
          </ul>
        </div>
      </div>
      <hr>
    </div>
    <div class="footer-container-copyright">
      <div class="footer-row-copyright">
        <div class="footer-copyright">
          <p class="copyright-text">Copyright &copy; 2023 All Rights Reserved by 
       <a href="index.html">TAMCA</a>.
          </p>
          <p>Designed and developed by Serdar Kurt</p>
        </div>

        <div class="footer-social">
          <ul class="social-icons">
            <li><a class="facebook" href="https://www.facebook.com/TAMCAYunusEmreCami/"><i class="fa fa-facebook"></i></a></li>
            <li><a class="instagram" href="https://www.instagram.com/tamcamosque/"><i class="fa fa-instagram"></i></a></li>
            <li><a class="whatsapp" href="https://wa.me/12673460615"><i class="fa fa-whatsapp"></i></a></li>
          </ul>
        </div>
      </div>
    </div>
</footer>

<script type="module">

  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-analytics.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut  } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, getDocs, updateDoc, query, where, onSnapshot, orderBy, limit  } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore.js";
  import { ref as sRef } from 'https://www.gstatic.com/firebasejs/10.3.1/firebase-storage.js';

  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional

  const firebaseConfig = {
  apiKey: "AIzaSyDDWF7ZTpiUySdlvdrckwFLhuhVItEtYzc",
  authDomain: "tamca-32b6f.firebaseapp.com",
  databaseURL: "https://tamca-32b6f-default-rtdb.firebaseio.com",
  projectId: "tamca-32b6f",
  storageBucket: "tamca-32b6f.appspot.com",
  messagingSenderId: "270078571509",
  appId: "1:270078571509:web:91877bf478b18ecfa2e6bc",
  measurementId: "G-9L44SWFGJ8"
  };

  const headers = {'Content-Type':'application/json',
                    'Access-Control-Allow-Origin':'*',
                    'Access-Control-Allow-Methods':'GET,POST,PATCH,OPTIONS'}
    // Initialize jsforce with your Salesforce credentials

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const firestore = getFirestore(app);
  const user = auth.currentUser;

    
  onAuthStateChanged(auth, (user) => {
  if (user) {
    // User is signed in, see docs for a list of available properties
    // https://firebase.google.com/docs/reference/js/auth.user
    const uid = user.uid;
    const userEmail = user.email;

    const uidQuery = query(
      collection(firestore, "contacts"), 
      where("uid", "==", uid)
    );

    getDocs(uidQuery)
        .then((querySnapshot) => {
            querySnapshot.forEach((docSnapshot) => {
              //console.log(docSnapshot.data());
              const data = docSnapshot.data();
              const email = data.email;
              const first_name = data.first_name;
              const membershipStatus = data.membership_status
              const membershipAutoRenewalStatus = data.membership_auto_renewal_status;
              const membershipRenewalDate = data.membership_renewal_date;
              const addressData = data.address;
              const addressId = data.address_id
              const firstNameElement = document.getElementById('first-name');
              const lastNameElement = document.getElementById('last-name');
              const emailNameElement = document.getElementById('profile-email');
              const phoneElement = document.getElementById('phone');

              firstNameElement.textContent = data.first_name;
              lastNameElement.textContent = data.last_name;
              emailNameElement.textContent = data.email;
              phoneElement.textContent = data.phone;

              if (addressData === null) {
                // Membership status is true
                document.getElementById('householdAddress').textContent = 'No household information on profile';
                // You can add more code for the true case here if needed
              } else {
                // Membership status is not true (false or something else)
                const { street, city, state, postalCode } = addressData;
                const formattedAddress = `${street}\n${city}, ${state} ${postalCode}`;
                document.getElementById('householdAddress').textContent = formattedAddress;
                // You can add more code for the false case here if needed
              }

              if (membershipStatus === 'Active') {
                // Membership status is true
                document.getElementById('membershipStatus').textContent = 'Active';
                document.getElementById('membershipStatus').style.color = 'green';
                // You can add more code for the true case here if needed
              } else {
                // Membership status is not true (false or something else)
                document.getElementById('membershipStatus').textContent = 'Inactive';
                document.getElementById('membershipStatus').style.color = 'red';
                // You can add more code for the false case here if needed
              }

              if (membershipAutoRenewalStatus === true) {
                // Membership status is true
                document.getElementById('autoRenewal').textContent = 'On';
                // You can add more code for the true case here if needed
              } else {
                // Membership status is not true (false or something else)
                document.getElementById('autoRenewal').textContent = 'Off';
                // You can add more code for the false case here if needed
              }

              document.getElementById('renewalDate').textContent = membershipRenewalDate;

              if (addressData !== null) {
      // Create a new Firestore query to fetch contacts with the same address
      const contactsRef = collection(firestore, "contacts");

      // Query the "contacts" collection where the "address" field matches the user's address
      const addressQuery = query(contactsRef, where("address_id", "==", addressId));


      const matchingContacts = [];
      getDocs(addressQuery)
        .then((addressQuerySnapshot) => {
          addressQuerySnapshot.forEach((contactDoc) => {
            // Handle the contacts with matching addresses
            const contactData = contactDoc.data();
            // console.log("Matching contact:", contactData);
            // You can perform further actions with the matching contacts here.
            matchingContacts.push(contactData);
          });
      // Insert matching contacts into the householdMembers span
        const householdMembersSpan = document.getElementById("householdMembers");

        // Clear the existing content
        householdMembersSpan.innerHTML = '';

        // Create a row for each matching contact
        matchingContacts.forEach((contact) => {
          const row = document.createElement('div');
          row.textContent = `${contact.first_name} ${contact.last_name} (${contact.membership_status})`;
          householdMembersSpan.appendChild(row);
        });
        })
        .catch((error) => {
          console.error("Error querying contacts by address:", error);
        });
        }
          })
        })

    const donationsRef = collection(firestore, "donations");
    const queryDonations = query(donationsRef, where("email_address", "==", userEmail), orderBy("transaction_date", "desc"), limit(3));

         // Reference the table and its body
    const donationTable = document.getElementById("donation-table");
    const donationTableBody = document.getElementById("donation-table-body");

    // Clear existing table data
    donationTableBody.innerHTML = "";

    // Fetch and populate donation data
    getDocs(queryDonations)
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          const donationData = doc.data();
          const transactionDate = donationData.transaction_date;
          const donationDate = transactionDate.toDate();
          const dondationAmount = donationData.transaction_amount;
          const donationCause = donationData.cause;

          // Create a new row in the table
          const newRow = document.createElement("tr");

          // Create cells for Date, Amount, and Cause
          const dateCell = document.createElement("td");
          const amountCell = document.createElement("td");
          const causeCell = document.createElement("td");

          // Add a CSS class to each cell
          dateCell.className = "donation-cell";
          amountCell.className = "donation-cell";
          causeCell.className = "donation-cell";

          const options = { year: 'numeric', month: 'short', day: '2-digit' };
          const formattedDate = donationDate.toLocaleDateString('en-US', options);

          dateCell.textContent = formattedDate; // Insert the formatted date
          amountCell.textContent = dondationAmount;
          causeCell.textContent = donationCause;

          newRow.appendChild(dateCell);
          newRow.appendChild(amountCell);
          newRow.appendChild(causeCell);

          // Append the row to the table body
          donationTableBody.appendChild(newRow);
        });
      })
      .catch((error) => {
        console.error("Error fetching donation data:", error);
      });


      // ...
  } else {

  }
  });

btnLogout.addEventListener('click', (e) => {
  signOut(auth).then(() => {
    // Sign-out successful.
    window.location.href = "login.html"
  }).catch((error) => {
    // An error happened.
  });
});

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsforce/1.10.1/jsforce.min.js"></script>
<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

</body>
</html>
